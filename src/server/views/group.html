<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Group</title>
    <style>
        p {
            white-space: nowrap;
            text-overflow: ellipsis;
            width: 280px;
            margin: 0 0 .2em 0;
        }
        h2 {
            margin: 0;
        }
        table {
            margin-bottom: 1em;
        }
        td {
            width: 300px;
            border: 1px solid rgba(100,100,100,0.3);
            padding: 5px;
            vertical-align: top;
            position: relative;
        }
        img {
            height: 100px;
        }
        .winner.image {
            background: lightgreen;
        }
        .winner.video {
            background: lightgoldenrodyellow;
        }
        label {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        input {
            position: absolute;
            top: 0.5em;
            right: 0.5em;
        }
        input:checked + label {
            background: lightcoral;
            opacity: 0.2;
        }
        .meta {
            margin: 0.4em;
            padding-right: 1.5em;
            float: right;
            font-size: 0.8em;
        }
        .delimiter {
            color: lightgray;
            margin: 0 .5em;
        }
        .wrong {
            color: red;
        }
    </style>
</head>
<body>

<% var start = 0; %>
<% var limit = 4000; %>
<% items = items.slice(start, start + limit); %>

<% function printDate(date) {
    const utcDate = new Date(date.toUTCString()); // –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –≤ UTC
    const options = { timeZone: process.env.TIMEZONE || 'UTC' }; // –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞

    return utcDate.toLocaleString('ru-RU', options);
} %>

<% function equalArray(arr, field) {
    for (let i = 1; i < arr.length; i++) {
        if (JSON.stringify(arr[i][field]) !== JSON.stringify(arr[0][field])) { return false; }
    }
    return true;
} %>

<form action="/groups" method="post">
<% for (const itemIndex in items) { %>
    <% const item = items[itemIndex] %>
    <h2>
        <%= parseInt(itemIndex, 10) + 1 %>. <span class="delimiter">|</span>
        <%= item.id %> <span class="delimiter">|</span>
        <%= item.date ? printDate(new Date(item.date * 1000)) : '' %> <span class="delimiter">|</span>
        &nbsp;‚è∞<%= equalArray(item.files, 'date') ? '‚úÖ' : '‚ùå' %>
        &nbsp;&nbsp;üõ∞<%= equalArray(item.files, 'gps') ? '‚úÖ' : '‚ùå' %>
    </h2>
    <table><tr>
        <% for (const file of item.files) { %>
            <td class="<%= file.win ? 'winner' : '' %> <%= file.type %>">
                <span class="meta"><%= file.exif.CompressorName %></span>
                <p><%= file.type === 'video' ? 'üé¨' : '' %><b><%= file.FileName %></b></p>
                <p class="<%= file.date !== item.date ? 'wrong' : '' %>">Date: <%= file.date ? printDate(new Date(file.date * 1000)) : '' %></p>
                <p><%= file.exif.ImageSize %> | <%= file.exif.FileSize %> | <%= file.exif.Duration %></p>
                <% if (file.gps) { %>
                    <p>GPS: <%= file.gps.lat %>, <%= file.gps.lon %></p>
                <% } %>
                <img src="<%= file.thumbnailUrl %>" />
                <input type="checkbox" name="files[]" value="<%= file.FileName %>" id="<%= file.FileName %>"/>
                <label for="<%= file.FileName %>" />
            </td>
        <% } %>
    </tr></table>
<% } %>
    <p>–û–ø–µ—Ä–∞—Ü–∏—è:
        <select name="operation">
            <option value="">Select operation</option>
            <option value="ungroup">Ungroup</option>
            <option value="delete">Delete</option>
        </select>
    </p>
    <p><button type="submit">Delete!</button></p>
</form>
</body>
</html>
